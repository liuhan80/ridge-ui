"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const F=require("./exception-B9XS0hPY.js"),d=require("./http-bypass-XpaATTSC.js"),k=require("nanoid");function J(t,e,o=1){return new Promise((i,r)=>{const n=indexedDB.open(t,o);n.onerror=a=>{console.error("数据库打开失败:",a.target.error),r(a.target.error)},n.onsuccess=a=>{console.log("数据库打开成功"),i(a.target.result)},n.onupgradeneeded=a=>{console.log("正在升级数据库版本");const p=a.target.result;p.objectStoreNames.contains(e)||p.createObjectStore(e,{keyPath:"key"})}})}async function K(t,e,o,i){return new Promise((r,n)=>{const u=t.transaction([e],"readwrite").objectStore(e).put({key:o,value:i});u.onsuccess=c=>{console.log("数据写入成功"),r()},u.onerror=c=>{console.error("数据写入失败:",c.target.error),n(c.target.error)}})}const m={},b={};function C(t){return Q("map",t,(e,o,i)=>{if(typeof o.data!==null&&typeof o.data=="object"){let r=o.data;if(t.format)try{r=t.format(o.data)}catch(n){throw new Error("数据格式化出错，请检查传入的数据是否符合预期",{cause:n})}v(m[e].data,r,1,i)}})}function N(t){return Q("list",t,(e,o,i)=>{let r=m[e].data;m[e].data.push(o.data),r.length>i&&i>0&&r.shift()})}function Q(t,e,o){const{tCodeList:i,interval:r,output:n,save:a=!1,outputNumber:p=1,limit:u=2}=e,c=[];if(e.merge){const s=k.nanoid(),E=n,l=o,f=t==="map"?{}:[];m[s]={code:s,data:f,total:0,start:d.getTimestamp(),uflag:!1},c.push(m[s]),d.TRecorder.subscribe(s,"debug",T=>{const S=s;i.includes(T.code)&&(m[S].utime=d.getTimestamp(),m[S].uflag=!0,m[S].total++,l(S,T,u,e.format))}),x(t,s,r,E,a,p)}else i.forEach(s=>{const E=`${s}_${t}`,l=n,f=o,T=t==="map"?{}:[];m[E]={code:s,data:T,total:0,start:d.getTimestamp(),uflag:!1},c.push(m[E]),d.TRecorder.subscribe(E,"debug",S=>{const R=E;s===S.code&&(m[R].utime=d.getTimestamp(),m[R].uflag=!0,m[R].total++,f(R,S,u,e.format))}),x(t,E,r,l,a,p)});return c}function x(t,e,o=10,i,r=!1,n=1){b[e]={counter:0,timer:setInterval(()=>{if(m[e].uflag||n===1){try{i({...m[e]})}catch(a){throw new Error("执行内存数据的处理函数失败",{cause:a})}finally{t==="list"&&(m[e].data=[])}r&&H(e,m[e]),m[e].uflag=!1}n>0&&(b[e].counter++,b[e].counter>=n&&(m[e].end=d.getTimestamp(),d.TRecorder.unsubscribe(e,"debug"),clearInterval(b[e].timer),delete m[e],delete b[e]))},o*1e3)}}function v(t,e,o=1,i=2){for(const r in e)e[r]===void 0||e[r]===null?t[r]=e[r]:typeof e[r]=="object"&&e[r]!==null&&o<=i?((!t[r]||typeof t[r]!="object")&&(t[r]={}),o++,v(t[r],e[r],o,i)):t[r]=e[r];return t}async function H(t,e){let o="{}",i=0;try{o=JSON.stringify(e,null,4)}catch(r){console.error(`fre>[${t}]>序列化自定义的Map内存数据失败`,r),i++}if(i>0)return!1;try{localStorage.setItem(t,o)}catch(r){console.error(`fre>[${t}]>写入localstorag失败`,r),i++}return i===0}function W(t){return m[`${t}_map`]}function I(t){return m[`${t}_list`]}function _(t){const e=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),i=String(t.getSeconds()).padStart(2,"0"),r=String(t.getMilliseconds()).padStart(3,"0");return`${e}:${o}:${i}.${r}`}function g(...t){console.warn("test>fre>",...t)}function A(){const t=C({tCodeList:["FRE_CLIENT_MQTT_CONNECTED","FRE_CLIENT_MQTT_RECONNECTING","FRE_CLIENT_MQTT_ERROR","FRE_CLIENT_MQTT_OFFLINE","FRE_CLIENT_MQTT_END","FRE_CLIENT_MQTT_DISCONNECT","FRE_CLIENT_MQTT_CLOSE"],outputNumber:0,limit:2,interval:1,merge:!0,output:n=>{}}),e=C({tCodeList:["FRE_CLIENT_MQTT_SUBSCRIBE_RETRY_ERROR","FRE_CLIENT_MQTT_SUBSCRIBE_RETRY_OK","FRE_CLIENT_MQTT_SUBSCRIBE_ERROR","FRE_CLIENT_MQTT_SUBSCRIBE_OK","FRE_CLIENT_MQTT_UNSUBSCRIBE_ERROR","FRE_CLIENT_MQTT_UNSUBSCRIBE_OK"],outputNumber:0,limit:2,interval:1,merge:!0,output:n=>{let a=n.data;for(let p in a)for(let u=0;u<t.length;u++){let c=t[u].data;if(c[p]){let s=c[p];s.topics||(s.topics=a[p])}}}});N({tCodeList:["FRE_CLIENT_MQTT_MESSAGE"],outputNumber:0,limit:0,interval:1,output:n=>{const a=e[0].data;n.data.forEach(u=>{const{url:c,topic:s}=u;if(a[c]){let E=a[c];if(E&&E[s]){let l=E[s];l.counter||(l.counter={dc:0,suber:{ok:0,ex:0,discard:0}}),l.counter.dc++}}})}}),N({tCodeList:["FRE_CLIENT_MQTT_CALLBACK_OK","FRE_CLIENT_MQTT_CALLBACK_ERROR"],outputNumber:0,limit:0,interval:1,output:function(n){const a=e[0].data;n.data.forEach(u=>{const{url:c,topic:s,status:E,error:l}=u;if(a[c]){let f=a[c];if(f&&f[s]){let T=f[s];T.counter&&(E==="ok"?T.counter.suber.ok++:T.counter.suber.ex++,l&&(T.counter.suber.error=l))}}})}});const o=N({tCodeList:["FC_TEST"],outputNumber:0,limit:0,interval:10,output:function(n){}}),i=N({tCodeList:["FC_ACCEPT"],outputNumber:0,limit:0,interval:10,output:function(n){}}),r=N({tCodeList:["TEST_view_updateProps"],outputNumber:0,limit:0,interval:10,output:function(n){}});return{status:t[0],bypass:{close:()=>(d.setMqttBypassSwitch(!1),"mqtt旁路已关闭"),open:n=>(d.setMqttBypassSwitch(!0,n),`mqtt旁路已开启,不受影响的主题列表：[${n?n.join(","):"无"}]`),test:()=>(N({tCodeList:["FRE_CLIENT_MQTT_MESSAGE_BYPASS_ON"],outputNumber:1,limit:0,interval:60,output:async function(n){g(`${_(new Date)}[mqtt]>录制的数据样本:`,n),g(`${_(new Date)}[mqtt]>关闭排除的主题.`),y.bypass.open();let a=o[0].total;g(`${_(new Date)}[mqtt]>渲染底数：${o[0].total}`),g(`${_(new Date)}[mqtt]>发送测试数据...`);let p=n.data,u=p.map(f=>({url:f.url,topic:f.topic,msg:JSON.parse(f.msg.toString())}));fetch("https://localhost:6001/api/mqtt/bypass",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)}).catch(async f=>({msg:"发送测试数据失败",error:f}));let c=p.length,s=200,E=50,l=await d.sendMqttData(p,s,E).catch(f=>({msg:"发送测试数据失败",error:f}));l.error?g(`${_(new Date)}[mqtt]>${l.msg}`,l.error):(a=o[0].total-a,g(`${_(new Date)}[mqtt]>${l.msg},样本长度:${c},发送条数:${c>0?s:0},间隔:${c>0?E:0}ms,渲染次数:${a},桥接:${i[0].total},updateProps:${r[0].total}`),g(y.bypass.open(w)),g(`${_(new Date)}[MQTT状态]>map>`,t[0]))}}),`${_(new Date)}[mqtt]>录制数据样本...`),get:()=>{g(`${_(new Date)}[mqtt]>关闭排除的主题.`),y.bypass.open(),d.setHttpBypassSwitch(!0);const n=N({tCodeList:["TEST_UNKNOWN"],outputNumber:0,limit:20,interval:60*60,output:function(f){}});let a=o[0].total,p=n[0].total;g(`${_(new Date)}[mqtt]>渲染底数,fc:${a},testUnknown:${p}`);let u={},c=e[0].data;for(let f in c)for(let T in c[f])w.forEach(S=>{T.startsWith(S)&&(u[S]||(u[S]=[]),u[S].push({fn:c[f][T].message,topic:T}))});const s=new WebSocket("wss://localhost:6001/dsl.pubsub");let E=10,l=0;return s.onopen=()=>{g(`${_(new Date)}[ws]连接成功`),s.send(JSON.stringify({limit:E,interval:l,topicList:w}))},s.onmessage=f=>{let{topic:T,msg:S,status:R}=JSON.parse(f.data);if(R)return g(`${_(new Date)}[mqtt]>设置特征值`,I("TEST_FEATURE_RESOLVER_SET")),g(`${_(new Date)}[mqtt]>探测`,I("TEST_UNKNOWN")),g(`${_(new Date)}[ws]服务端响应：`,R,`
                              发送条数:${E},
                                  间隔:${l}ms,
                              渲染次数:${o[0].total-a},
                                  桥接:${i[0].total},
                                 testUnknown:${n[0].total-p},                         
                            `);for(let P in u)P===T&&(u[T].forEach(q=>q.fn(q.topic,Buffer.from(JSON.stringify(S),"utf-8"),"bypass")),d.tR({code:"FC_SEND",data:"发送",traceId:""}))},s.onclose=f=>{g(`${_(new Date)}[ws]关闭连接，服务端响应：`,f)},`${_(new Date)}[ws]>获取测试数据...`}}}}const w=["/monobj/viewtemplate2/group/fanFarmMainGroupId"],y=A();function G(){return{bypass:{record:t=>(N({tCodeList:["FRE_CLIENT_RESPONSE_0","FRE_CLIENT_RESPONSE_1","FRE_CLIENT_RESPONSE_2"],outputNumber:0,limit:0,interval:2,output:e=>{fetch("https://localhost:6001/api/http/bypass/curator",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(o=>({msg:"发送测试数据成功",data:o})).catch(async o=>({msg:"发送测试数据失败",error:o}))}}),`${_(new Date)}[http]>录制数据样本...`),get:t=>(d.setHttpBypassSwitch(!0,Y),`${_(new Date)}[http]>获取数据样本...`)}}}const Y=[],V=G(),$={};let L,B,O=!1,h,j;function M(...t){console.warn("fre>",...t)}function z(t,e=100){const o="fre",i={exception:{start:()=>(F.outputException(),e>0&&(h=`${o}/exception.json`,j=e,L=t,X(),Z()),"异常输出已开启。")},memory:{debug:(r,n,a=10,p=1,u=10)=>{let c,s={list:(...E)=>N({tCodeList:n,interval:a,output:l=>{M(`[${l.code}]>${r}>`,l)},outputNumber:p,limit:u}),map:(...E)=>C({tCodeList:n,interval:a,output:l=>{M(`[${l.code}]>${r}>`,l)},outputNumber:p,limit:u})};if(s[r])c=s[r](n,a,p,u);else return`[${n.join(",")}]>${r}> not support !`;return c?`[${n.join(",")}]>${r}> start at ${_(new Date)} ...`:`[${n.join(",")}]>${r}> already existing !`},mqtt:y,http:V,getMap:r=>W(r),getList:r=>I(r)}};return M("监控器已开启"),i}let D=0;function X(){let t=JSON.parse(localStorage.getItem(h)||"{}");for(let e in t)$[e]=t[e];localStorage.setItem(h,JSON.stringify({...$},null,4)),F.ERecorder.subscribe("memory","error",e=>{D>=j||($[e.code]&&D++,$[e.code]=e,O=!0)})}function Z(){B=setInterval(async()=>{U()},1e4)}async function U(){if(O){try{localStorage.setItem(h,JSON.stringify({...$},null,4)),D=0,O=!1}catch(t){console.error(`[${L}]写入localstorag失败:${h}`,t)}try{const t=await J("FRE","Exception");let e=K(t,"Exception","shop",JSON.stringify({...$}));await e,e.catch(o=>{console.error("妈呀",o)})}catch(t){console.error(`[${L}]写入IndexDB失败:${h}`,t)}}}function tt(){et(),rt(),U(),M("客户端监视已关闭")}function et(){Object.keys($).forEach(t=>{delete $[t]}),F.ERecorder.unsubscribe("memory","error")}function rt(){clearInterval(B)}exports.startClientMonitor=z;exports.stopClientMonitor=tt;
