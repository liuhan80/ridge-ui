"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const i=require("./exception-B9XS0hPY.js"),o=require("chalk"),y=require("readline"),h=require("fs"),w=require("path");function p(e){const r=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const t in e)if(t!=="default"){const s=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,s.get?s:{enumerable:!0,get:()=>e[t]})}}return r.default=e,Object.freeze(r)}const u=p(h),S=p(w),k=e=>({info:r=>{c(o.rgb(79,193,255)(`[${e}]`),r)},error:r=>{c(o.red(`[${e}]:exception>`),r)},warn:r=>{c(o.yellow(`[${e}]`),r)},ITracking:r=>{c(o.rgb(255,193,255)(`[${e}]`),r)}});function c(e,r){console.log(e,o.grey(new Date().toISOString())),console.error(r)}let g;function v(){i.ERecorder.subscribe("console","error",e=>{g.error(e)})}function f(){i.ERecorder.unsubscribe("console","error")}const n={};let b,l=!1,m;function M(){i.ERecorder.subscribe("memory","error",e=>{n[e.code]=e,l=!0})}function O(){i.ERecorder.unsubscribe("memory","error")}function j(){b=setInterval(async()=>{d()},1e4)}function E(){clearInterval(b)}async function d(){if(!l)return;const e=`${m}/exception.json`,r=S.dirname(e);try{await u.promises.mkdir(r,{recursive:!0});const t={...n};await u.promises.writeFile(e,JSON.stringify(t,null,4),"utf8"),l=!1}catch(t){console.error("文件操作失败:",t)}}function $(e,r){if(m=r,M(),j(),!process.stdin.isTTY)return;const t=y.createInterface({input:process.stdin,output:process.stdout,prompt:"fre>"});t.prompt(),t.on("line",s=>{const a=s.trim();switch(a){case"startException":v(),console.log(o.green("异常信息屏幕输出已开启"));break;case"stopException":f(),console.log(o.green("异常信息屏幕输出已关闭"));break;case"shopException":console.log(o.grey("snapshot start:----------------------------------------------------------------------------------")),console.log(n),console.log(o.gray("snapshot end----------------------------------------------------------------------------------"));break;case"":break;default:console.log(o.yellow(`未知命令: ${a}`));break}t.prompt()}),g=k(e),console.log(o.green(`[${e}]异常监视已启动`)),console.log(o.green("[")),console.log(o.green("  可通过以下命令控制：")),console.log(o.rgb(79,193,255)("    start: 开启异常信息的屏幕输出")),console.log(o.rgb(79,193,255)("    stop: 关闭异常信息的屏幕输出")),console.log(o.rgb(79,193,255)("    shop: 屏幕输出：所有异常最近一次产生的实例信息")),console.log(o.green(`  快照文件: ${r}/exception.json`)),console.log(o.grey("      注：如果有变化，快照文件每10秒更新一次，服务退出前会主动写入快照文件")),console.log(o.green("]"))}function x(){f(),O(),E(),d(),Object.keys(n).forEach(e=>{delete n[e]}),console.log(o.green("服务监视已关闭"))}exports.startServiceMonitor=$;exports.stopServiceMonitor=x;
